# 对账

对账通常分3类，业务对账，资金对账，账单对账

## 业务对账

通常情况下，业务对账就是用来**恢复掉单数据**。

业务对账单一般包括有：**支付公司流水号，银行流水号，金额，标识状态（成功或失败）**。

对于原交易单据未明确交易状态的掉单交易，通过业务对账，可以更快的明确**单据状态**。由此看来，**业务对账文件就是移动交易回执单据的补充，业务对账的明细与交易发生时的银行回执是等价的，目的是为了明确交易状态，以确认因此产生的负债关系**。

**业务对账文件 = 掉单查询回执 = 联机交易回执**

（PS：掉单就是，因为网络通信问题，导致报文丢失）

通俗点说，一笔快捷支付请求，从支付宝发往银行，银行处理，再到银行回执支付宝这个过程，任何一个环节出现了问题，都会导致最后支付宝无法得知最后的支付处理结果。所以极端情况就是银行处理并扣了用户银行卡余额，但是没通知到支付宝，支付宝这边不能给用户处理成功，正好碰上掉单查询接口出点幺蛾子，那这个用户就要急死了。

## 资金对账

主要作用，就是**明确在某一个结算周期内，由业务产生结果的债权债务关系的清偿约定**。

小明问小红借钱，打了好几个借条上面写着“兹有小明，于XXXX日借小红XXX元人民币，复利年化5%”字样，落款是小明的签名。分别编号为a，b，c，d，e，f，g…… 这堆借条，明确了“小明欠小红钱”这个生产关系实质，没错，相当于我们之前说的业务对账。既然借了钱，也写了借条，那么啥时候还钱呢? 小明和小红约定，每个月月初，小明会跟小红确认当月月底会还哪些借条，一样的白纸黑字不可抵赖。内容大致如下：“2014年8月31日24点前，小明承诺将所欠小红的a,b,c三张借条及其利息，共XXXX元汇入小红银行账户”。画押：小明。大家知道，小明欠小红好多借条，远远不止abc三张。但欠钱是一回事，啥时候还钱是另一回事，欠你钱不代表我必须一口气还掉。

所以这个月初条款，就是用来明确在8月份这个结算周期内小明与小红债权债务清偿的方案——映射到我们今天谈的内容，它就相当于资金对账在我们业务开展过程中的作用。

在实际业务中，由于交易处理时差，会计日不一致等各种原因：由于银行会计日切在22点，所以一笔8月27日23点发生的交易在银行看来，是发生在28日的，所以在29日由银行主动清算到支付宝的备付金账户。又由于银行日切时间是浮动的，且资金清算方案在协议中通常约定以银行为准，所以通常对于**收单类交易**，支付宝不会自己去掰指头算，今天工行应该给我多少钱，农行该给我多少钱……而是**根据银行给**的**资金文件**来明确。

资金文件通常包括：**银行流水号，支付宝流水号，金额，业务类型**

可以看出，资金文件不包含交易状态，意思就是：交易成功了才会记在这个资金文件（正向和反向的成功）

# 冲正

冲正，就是系统认为可能交易失败时，采取的补救措施。

**冲正交易不光要求对已有交易进行回滚，语义上他还要求应答系统对该交易流水进行幂等控制——将该交易流水插入幂等表，即便后续该交易报文再抵达，也予以拒绝交易。**

# 热点账户

对于较大型的支付公司和机构，如果他们的银行账户在每次支付成功时都**实时**更新余额，将会给银行带来很大的系统压力。这个账户，也就是所谓的，热点账户。

解决热点账户问题：

1. 汇总入账：

   银行在T日业务完成日切之后，将T日发生的所有成功交易进行统计，计算出总额，然后一笔汇总到指定账户。

   主要优势：数据库压力很小，日间所有交易全部是insert入表（支持高并发以及分布式部署），日终只需要sum出结果就可以了。

   主要劣势：T日交易款要到T+1日才能结算到账。

2. 缓冲记账：

   将实时同步的记账变成异步，以达到记账实时性和系统稳定性间的平衡。

   例子：支付宝和工行合作推出“实时转账到卡”产品，用户从支付宝端发起转账后可以立即看到账户资金入账。支付宝方面不会由于接口并发限制而挂起用户的交易，这个交易都是同步调用同步返回。换言之，用户看到的产品体验是：手机客户端输入转账信息，点击确定，支付宝转几秒菊花，返回转账成功/失败（没有中间业务状态）。

   对于日间报送的转账请求，**工行只校验账户合法有效性**，只要账户一切正常就直接返回转账成功，反之则转账失败。然后在后台做一个队列，**把这些成功的交易排个队，以一秒30笔的速度进行处理**。

   也就是说：支付宝报送的交易低于30笔/秒的时候，工行系统几乎还是实时地处理了账务变更，而当交易大于30笔/秒的时候，**工行就先返回转账结果**，**把账务处理丢到队列中**，等并发量不大的时候慢慢消化，对用户来说感受到的体验还是几秒钟就转账成功了，看上去皆大欢喜。









